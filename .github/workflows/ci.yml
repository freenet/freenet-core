name: CI

# Cost optimization strategy (Ubicloud runners ~$0.13/run):
# 1. Skip CI entirely for docs-only changes (paths-ignore)
# 2. Skip expensive jobs (Test, six-peer) on main push - PR already validated
# 3. Skip six-peer-regression for dependabot PRs - Test is sufficient for version bumps
# 4. Run fast checks (Fmt, Clippy) in parallel for quick fail-fast
# 5. Use merge_group to skip redundant tests before merge
# Estimated savings: ~25-30% reduction in CI costs

on:
  push:
    branches: [main]
    # Skip CI for docs-only changes on main (saves ~$0.13/run)
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/FUNDING.yml'
  pull_request:
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/FUNDING.yml'
  merge_group:

# Cancel in-progress runs when a new commit is pushed to the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Fast checks first - fail fast on simple issues
  # Order: fastest to slowest for single-runner efficiency

  # Fast checks on GitHub-hosted runners (don't block nova)
  conventional_commits:
    name: Conventional Commits
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check PR title follows Conventional Commits
        uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            doesn't start with an uppercase character.

  fmt_check:
    name: Fmt
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Run in parallel with conventional_commits (both are fast GitHub-hosted checks)

    steps:
      - uses: actions/checkout@v6

      # Pin to 1.91.0 to avoid rustc 1.92.0 ICE in monomorphization
      # See: https://github.com/rust-lang/rust/issues/147164
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.91.0
          components: rustfmt

      - name: Check code formatting
        run: cargo fmt -- --check

  # Clippy runs in parallel with fmt_check for faster fail-fast
  # Using Ubicloud for faster builds with more cores
  clippy_check:
    name: Clippy
    runs-on: ubicloud-standard-8
    timeout-minutes: 15
    # No dependencies - runs immediately in parallel with fmt_check

    env:
      RUST_LOG: error
      RUST_MIN_STACK: 268435456

    steps:
      - uses: actions/checkout@v6

      - name: Install mold linker
        run: |
          sudo apt-get update
          sudo apt-get install -y mold

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.91.0
          components: clippy
          targets: wasm32-unknown-unknown

      - uses: Swatinem/rust-cache@v2

      - name: clippy
        env:
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER: clang
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: -C link-arg=-fuse-ld=mold
        run: cargo clippy --locked -- -D warnings

  test_all:
    name: Test
    runs-on: ubicloud-standard-16
    timeout-minutes: 30
    needs: fmt_check
    # Skip on:
    # - merge_group: PR already passed full tests
    # - push to main: PR already validated code before merge (saves ~$0.08/push)
    # - release PRs: only bump versions, main already passed CI
    if: |
      github.event_name == 'pull_request' &&
      !startsWith(github.head_ref, 'release/v')

    env:
      # RUST_LOG controls tracing output level (used by both test-log and production code)
      RUST_LOG: error
      CARGO_TARGET_DIR: ${{ github.workspace }}/target
      # Increase rustc stack size to prevent SIGSEGV during compilation
      # 256MB required for LLVM optimization passes on large workspaces (rustc suggests this value)
      RUST_MIN_STACK: 268435456

    steps:
      - uses: actions/checkout@v6

      - name: Install mold linker
        run: |
          sudo apt-get update
          sudo apt-get install -y mold

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.91.0
          targets: wasm32-unknown-unknown

      - uses: Swatinem/rust-cache@v2
        if: success() || steps.test.conclusion == 'failure'
        with:
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Build
        env:
          # Use mold linker to avoid rust-lld crashes (see issue #2519)
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER: clang
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: -C link-arg=-fuse-ld=mold
        run: |
          cargo build --locked
          export PATH="$PWD/target/debug:$PATH"
          make -C apps/freenet-ping -f run-ping.mk build

      - name: Clean test directories
        run: |
          # Remove freenet test directories from /tmp to avoid permission issues
          # when tests create directories with different user ownership
          rm -rf /tmp/freenet /tmp/freenet-* 2>/dev/null || true

      - name: Test
        env:
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER: clang
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: -C link-arg=-fuse-ld=mold
          # Default congestion control is FixedRate for CI stability.
          # To test BBR: set FREENET_CONGESTION_CONTROL=bbr and optionally FREENET_BBR_STARTUP_RATE
        # Run all tests in parallel using all 16 cores
        # Exclude operations tests (run separately with limited parallelism due to transport bandwidth constraints)
        # Simulation tests excluded via feature flag
        run: cargo test --workspace --no-default-features --features trace,websocket,redb -- --test-threads=16 --skip test_put --skip test_get --skip test_update --skip test_subscription

      - name: Test operations (serial)
        env:
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER: clang
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: -C link-arg=-fuse-ld=mold
        # Operations tests create real network connections on localhost.
        # Run serially for reliable test results.
        run: cargo test -p freenet --no-default-features --features trace,websocket,redb --test operations -- --test-threads=1

      - name: Test simulation (serial)
        env:
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER: clang
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: -C link-arg=-fuse-ld=mold
        # Simulation tests use global state (socket registries, RNG, counters)
        # and must run serially to avoid race conditions
        run: |
          cargo test -p freenet --no-default-features --features trace,websocket,redb,simulation_tests \
            --test simulation_integration \
            --test simulation_smoke \
            -- --test-threads=1

  six_peer_regression:
    name: six-peer-regression
    needs: fmt_check  # Changed from test_all to avoid dependency skip cascade
    runs-on: ubicloud-standard-16
    timeout-minutes: 30
    # Skip on:
    # - merge_group: PR already passed full tests
    # - push to main: PR already validated code before merge (saves ~$0.03/push)
    # - release PRs: only bump versions
    # - dependabot PRs: just version bumps, Test job is sufficient (saves ~$0.03/dependabot PR)
    if: |
      github.event_name == 'pull_request' &&
      !startsWith(github.head_ref, 'release/v') &&
      !startsWith(github.head_ref, 'dependabot/')

    env:
      RUST_LOG: error
      # Increase rustc stack size to prevent SIGSEGV during compilation
      # 256MB required for LLVM optimization passes on large workspaces (rustc suggests this value)
      RUST_MIN_STACK: 268435456

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mold liblzma-dev

      - name: Checkout river
        uses: actions/checkout@v6
        with:
          repository: freenet/river
          ref: main
          path: river-src

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.91.0

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            .
            river-src

      - name: Pull Docker images for NAT simulation
        run: |
          # Pre-pull alpine image used by NAT router simulation
          # Without this, the test fails with "No such image: alpine:latest"
          docker pull alpine:latest

      - name: Run six-peer regression
        working-directory: river-src
        env:
          FREENET_CORE_PATH: ${{ github.workspace }}
          RUST_LOG: info
          # Use mold linker to avoid rust-lld crashes (see issue #2519)
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER: clang
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: -C link-arg=-fuse-ld=mold
        # Use Docker NAT to simulate realistic network topology where peers
        # are behind NAT and gateways are on the public network. This provides
        # better test coverage for NAT traversal and gateway connection code paths.
        # See issue #2204 for context.
        # IMPORTANT: This test MUST run with Docker NAT. If Docker is unavailable,
        # the test fails rather than silently falling back to local mode, which
        # would skip NAT hole punching validation entirely.
        run: |
          if ! docker info >/dev/null 2>&1; then
            echo "ERROR: Docker is not available but is REQUIRED for NAT hole punching tests"
            echo "A test that doesn't test what it claims to test is worse than no test"
            exit 1
          fi
          echo "Docker available - using Docker NAT backend"
          export FREENET_TEST_DOCKER_NAT=1
          cargo test --test message_flow river_message_flow_over_freenet_six_peers_five_rounds -- --ignored --exact

  claude-ci-analysis:
    name: Claude CI Analysis
    runs-on: ubicloud-standard-4
    timeout-minutes: 30
    needs: [clippy_check, fmt_check]  # Removed test_all to avoid dependency skip cascade
    # Only run on PRs with claude-debug label when there's a failure
    if: |
      github.event_name == 'pull_request' &&
      failure() &&
      contains(github.event.pull_request.labels.*.name, 'claude-debug')

    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 10
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Check Claude fix attempt count
        id: check-attempts
        run: |
          # Count how many times Claude has already tried to fix this
          ATTEMPT_COUNT=$(git log -10 --pretty=%B | grep -c "ðŸ¤– Claude CI fix attempt" || echo "0")
          echo "Current attempt count: $ATTEMPT_COUNT"

          if [ "$ATTEMPT_COUNT" -ge 2 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âŒ Claude has already made 2 fix attempts. Stopping to prevent infinite loop."
          else
            NEXT_ATTEMPT=$((ATTEMPT_COUNT + 1))
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "attempt_number=$NEXT_ATTEMPT" >> $GITHUB_OUTPUT
            echo "âœ… Proceeding with fix attempt $NEXT_ATTEMPT/2"
          fi

      - name: Run Claude CI Fix
        if: steps.check-attempts.outputs.skip != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            PR BRANCH: ${{ github.event.pull_request.head.ref }}
            FIX ATTEMPT: ${{ steps.check-attempts.outputs.attempt_number }}/2

            The CI workflow has failed. Your task is to:
            1. Analyze the CI failure logs to identify the root cause
            2. Fix the code to resolve the issue
            3. Commit and push your fixes to the PR branch

            IMPORTANT COMMIT MESSAGE FORMAT:
            Your commit message MUST include:
            - Clear description of what you fixed
            - The marker: "ðŸ¤– Claude CI fix attempt ${{ steps.check-attempts.outputs.attempt_number }}/2"
            - This prevents infinite loops and tracks attempt count

            Example commit message:
            "Fix: [description of fix]

            ðŸ¤– Claude CI fix attempt ${{ steps.check-attempts.outputs.attempt_number }}/2

            Co-authored-by: Claude <noreply@anthropic.com>"

            GUIDELINES:
            - Make focused, minimal changes to fix the specific CI failure
            - Do not make unrelated improvements
            - Use git commands to commit and push your changes
            - After pushing, CI will run automatically

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(gh api:*),Bash(gh run view:*),Bash(git status:*),Bash(git diff:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(git log:*)"'
