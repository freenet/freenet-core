name: Simulation Tests (Nightly)

# Large-scale simulation tests that are too slow for regular CI.
# Standard simulation tests (sim_network, simulation_integration, etc.)
# already run on every PR via the main CI workflow.

on:
  schedule:
    # Run at 3 AM UTC every day
    - cron: '0 3 * * *'
  workflow_dispatch:
    # Allow manual triggering from any branch
    inputs:
      ref:
        description: 'Git ref to checkout (branch, tag, or SHA). Leave empty to use the branch selected in the UI.'
        required: false
        default: ''
      seed:
        description: 'Simulation seed for reproducibility (hex, e.g., 0xDEADBEEF)'
        required: false
        default: ''

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  large-scale-simulation:
    name: Large Scale Simulation
    runs-on: self-hosted
    timeout-minutes: 120

    env:
      RUST_LOG: info
      CARGO_TARGET_DIR: ${{ github.workspace }}/target
      RUST_MIN_STACK: 16777216
      # Use mold linker to avoid rust-lld crashes
      CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER: clang
      CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: -C link-arg=-fuse-ld=mold
      # Simulation seed - use input if provided, otherwise use fixed seed for reproducibility
      SIMULATION_SEED: ${{ github.event.inputs.seed || '0xDEADBEEF' }}

    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: Show checked out ref
        run: |
          echo "Checked out ref: $(git rev-parse --abbrev-ref HEAD || git rev-parse HEAD)"
          echo "Commit: $(git rev-parse HEAD)"

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.91.0

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: simulation-large
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Clean test directories
        run: |
          rm -rf /tmp/freenet /tmp/freenet-* 2>/dev/null || true

      # Build fdev for simulation tests
      - name: Build fdev
        run: cargo build -p fdev --release

      # Medium scale test (50 nodes) - scaled up from 20 for better coverage
      # Expects 100% success rate and 100% convergence - no fault injection
      - name: Medium scale test (50 nodes, seed 0xDEADBEEF)
        run: |
          echo "Running medium scale simulation (50 nodes, 2000 events)"
          cargo run -p fdev --release -- test \
            --name "nightly-medium-50" \
            --seed 0xDEADBEEF \
            --gateways 4 \
            --nodes 46 \
            --events 2000 \
            --ring-max-htl 12 \
            --max-connections 20 \
            --min-connections 6 \
            --min-success-rate 1.0 \
            --print-summary \
            single-process

      # Medium scale with different seed (explores different code paths)
      # Expects 100% success rate and 100% convergence - no fault injection
      - name: Medium scale test (50 nodes, seed 0xCAFEBABE)
        run: |
          echo "Running medium scale simulation with alternate seed (2000 events)"
          cargo run -p fdev --release -- test \
            --name "nightly-medium-50-alt" \
            --seed 0xCAFEBABE \
            --gateways 4 \
            --nodes 46 \
            --events 2000 \
            --ring-max-htl 12 \
            --max-connections 20 \
            --min-connections 6 \
            --min-success-rate 1.0 \
            --print-summary \
            single-process

      # Fault tolerance test with aggressive message loss
      # Success rate can be <100% due to message loss, but convergence must be 100%
      # (all contracts that DO get created must have consistent state)
      - name: Fault tolerance test (15% message loss)
        run: |
          echo "Running fault tolerance simulation with 15% message loss (1000 events)"
          cargo run -p fdev --release -- test \
            --name "nightly-fault-loss" \
            --seed 0xFA017001 \
            --gateways 3 \
            --nodes 27 \
            --events 1000 \
            --message-loss 0.15 \
            --min-success-rate 0.80 \
            --print-summary \
            --print-network-stats \
            single-process

      # High latency test
      # Latency adds delay but shouldn't cause message loss, so success rate should be high
      # Allow 95% to account for potential timeout edge cases
      - name: High latency test (50-200ms latency)
        run: |
          echo "Running high latency simulation (500 events)"
          cargo run -p fdev --release -- test \
            --name "nightly-high-latency" \
            --seed 0x1A7E0C71 \
            --gateways 2 \
            --nodes 12 \
            --events 500 \
            --latency-min 50 \
            --latency-max 200 \
            --min-success-rate 0.95 \
            --print-summary \
            --print-network-stats \
            single-process

      # Large scale test (500 nodes) - stress test with many events
      # Expects 100% success rate and 100% convergence - no fault injection
      - name: Large scale test (500 nodes)
        run: |
          echo "Running large scale simulation (500 nodes, 10000 events)"
          cargo run -p fdev --release -- test \
            --name "nightly-large-500" \
            --seed 0x500BEEF \
            --gateways 10 \
            --nodes 490 \
            --events 10000 \
            --ring-max-htl 15 \
            --max-connections 30 \
            --min-connections 10 \
            --min-success-rate 1.0 \
            --print-summary \
            single-process

      # Replica validation with step-by-step consistency checking
      # Runs in 3 phases, verifying convergence and replica counts after each
      # NOTE: This test reveals convergence issues - failures are expected and logged for investigation
      - name: Replica validation test (stepwise consistency)
        run: |
          echo "Running replica validation with step-by-step consistency"
          echo "NOTE: This test may fail due to known convergence issues being investigated"
          cargo test -p freenet --features simulation_tests --test sim_network \
            replica_validation_and_stepwise_consistency -- \
            --ignored --test-threads=1 --nocapture || echo "Test failed - convergence issues detected (expected)"

      # Dense network replication test (higher connectivity)
      - name: Dense network replication test
        run: |
          echo "Running dense network replication test"
          cargo test -p freenet --features simulation_tests --test sim_network \
            dense_network_replication -- \
            --ignored --test-threads=1 --nocapture

      # Large network test - requires riverctl, skipped if not available
      - name: Run large network test (50+ nodes)
        run: |
          echo "Running large network simulation with seed: $SIMULATION_SEED"
          if command -v riverctl &> /dev/null; then
            cargo test -p freenet --test large_network -- --ignored --nocapture --test-threads=1
          else
            echo "Skipping large_network test - riverctl not installed"
          fi

  # Notify Matrix channel on failure
  # Uses curl directly because the matrix-message action doesn't URL-encode room IDs
  notify-failure:
    name: Notify Matrix on Failure
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: large-scale-simulation
    if: failure()
    steps:
      - name: Send failure message to Matrix
        env:
          MATRIX_ACCESS_TOKEN: ${{ secrets.MATRIX_ACCESS_TOKEN }}
          MATRIX_ROOM_ID: ${{ secrets.MATRIX_DEV_ROOM_ID }}
        run: |
          # URL-encode the room ID (! -> %21, : -> %3A)
          ENCODED_ROOM_ID=$(echo "$MATRIX_ROOM_ID" | sed 's/!/%21/g; s/:/%3A/g')

          # Construct message body
          MESSAGE=$(cat <<'EOF'
          ðŸš¨ **Nightly Simulation Tests Failed**

          **Repository:** [${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})
          **Run:** [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          **Branch:** `${{ github.ref_name }}`
          **Commit:** `${{ github.sha }}`
          **Seed:** `${{ github.event.inputs.seed || '0xDEADBEEF' }}`

          Please investigate the failure and check the logs for details.
          EOF
          )

          # Send to Matrix
          curl -sf -X PUT \
            "https://matrix.org/_matrix/client/v3/rooms/${ENCODED_ROOM_ID}/send/m.room.message/$(date +%s%N)" \
            -H "Authorization: Bearer ${MATRIX_ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg body "$MESSAGE" '{msgtype: "m.text", body: $body, format: "org.matrix.custom.html", formatted_body: $body}')"

