name: Simulation Tests (Nightly)

# Large-scale simulation tests that are too slow for regular CI.
# Standard simulation tests (sim_network, simulation_integration, etc.)
# already run on every PR via the main CI workflow.

on:
  schedule:
    # Run at 3 AM UTC every day
    - cron: "0 3 * * *"
  workflow_dispatch:
    # Allow manual triggering from any branch
    inputs:
      ref:
        description: "Git ref to checkout (branch, tag, or SHA). Leave empty to use the branch selected in the UI."
        required: false
        default: ""
      seed:
        description: "Simulation seed for reproducibility (hex, e.g., 0xDEADBEEF)"
        required: false
        default: ""

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  large-scale-simulation:
    name: Large Scale Simulation
    runs-on: self-hosted
    timeout-minutes: 120

    env:
      RUST_LOG: info
      CARGO_TARGET_DIR: ${{ github.workspace }}/target
      RUST_MIN_STACK: 16777216
      # Use mold linker to avoid rust-lld crashes
      CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER: clang
      CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: -C link-arg=-fuse-ld=mold
      # Simulation seed - use input if provided, otherwise use fixed seed for reproducibility
      SIMULATION_SEED: ${{ github.event.inputs.seed || '0xDEADBEEF' }}

    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: Show checked out ref
        run: |
          echo "Checked out ref: $(git rev-parse --abbrev-ref HEAD || git rev-parse HEAD)"
          echo "Commit: $(git rev-parse HEAD)"

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.91.0

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: simulation-large
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Clean test directories
        run: |
          rm -rf /tmp/freenet /tmp/freenet-* 2>/dev/null || true

      # Build fdev for simulation tests
      - name: Build fdev
        run: cargo build -p fdev --release

      # Medium scale test (50 nodes) - 1 hour virtual time with realistic jitter
      # Expects 100% success rate and 100% convergence
      # Virtual time: 2000 events Ã— 1800ms = 3600s (1 hour)
      - name: Medium scale test (50 nodes, 1h, seed 0xDEADBEEF)
        run: |
          echo "Running medium scale simulation (50 nodes, 2000 events, 1 hour virtual time)"
          cargo run -p fdev --release -- test \
            --name "nightly-medium-50-1h" \
            --seed 0xDEADBEEF \
            --gateways 4 \
            --nodes 46 \
            --events 2000 \
            --event-wait-ms 1800 \
            --ring-max-htl 12 \
            --max-connections 20 \
            --min-connections 6 \
            --latency-min 10 \
            --latency-max 50 \
            --min-success-rate 1.0 \
            --print-summary \
            --print-network-stats \
            single-process

      # Medium scale with different seed (explores different code paths)
      # 1 hour virtual time with realistic jitter
      # Virtual time: 2000 events Ã— 1800ms = 3600s (1 hour)
      - name: Medium scale test (50 nodes, 1h, seed 0xCAFEBABE)
        run: |
          echo "Running medium scale simulation with alternate seed (2000 events, 1 hour virtual time)"
          cargo run -p fdev --release -- test \
            --name "nightly-medium-50-1h-alt" \
            --seed 0xCAFEBABE \
            --gateways 4 \
            --nodes 46 \
            --events 2000 \
            --event-wait-ms 1800 \
            --ring-max-htl 12 \
            --max-connections 20 \
            --min-connections 6 \
            --latency-min 10 \
            --latency-max 50 \
            --min-success-rate 1.0 \
            --print-summary \
            --print-network-stats \
            single-process

      # Fault tolerance test with aggressive message loss + realistic jitter
      # 1 hour virtual time to catch time-dependent issues under load
      # Success rate can be <100% due to message loss, but convergence must be 100%
      # Virtual time: 1000 events Ã— 3600ms = 3600s (1 hour)
      - name: Fault tolerance test (15% message loss, 1h)
        run: |
          echo "Running fault tolerance simulation with 15% message loss (1000 events, 1 hour virtual time)"
          cargo run -p fdev --release -- test \
            --name "nightly-fault-loss-1h" \
            --seed 0xFA017001 \
            --gateways 3 \
            --nodes 27 \
            --events 1000 \
            --event-wait-ms 3600 \
            --message-loss 0.15 \
            --latency-min 10 \
            --latency-max 50 \
            --min-success-rate 0.80 \
            --print-summary \
            --print-network-stats \
            single-process

      # High latency test - 1 hour virtual time
      # Tests behavior under sustained high latency conditions
      # Virtual time: 500 events Ã— 7200ms = 3600s (1 hour)
      - name: High latency test (50-200ms latency, 1h)
        run: |
          echo "Running high latency simulation (500 events, 1 hour virtual time)"
          cargo run -p fdev --release -- test \
            --name "nightly-high-latency-1h" \
            --seed 0x1A7E0C71 \
            --gateways 2 \
            --nodes 12 \
            --events 500 \
            --event-wait-ms 7200 \
            --latency-min 50 \
            --latency-max 200 \
            --min-success-rate 0.95 \
            --print-summary \
            --print-network-stats \
            single-process

      # Large scale test (500 nodes) - 3 hour virtual time with realistic jitter
      # Extended duration stress test to catch time-dependent scaling issues
      # Virtual time: 10000 events Ã— 1080ms = 10800s (3 hours)
      - name: Large scale test (500 nodes, 3h)
        run: |
          echo "Running large scale simulation (500 nodes, 10000 events, 3 hours virtual time)"
          cargo run -p fdev --release -- test \
            --name "nightly-large-500-3h" \
            --seed 0x500BEEF \
            --gateways 10 \
            --nodes 490 \
            --events 10000 \
            --event-wait-ms 1080 \
            --ring-max-htl 15 \
            --max-connections 30 \
            --min-connections 10 \
            --latency-min 10 \
            --latency-max 50 \
            --min-success-rate 1.0 \
            --print-summary \
            --print-network-stats \
            single-process

      # Replica validation with step-by-step consistency checking
      # Runs in 3 phases, verifying convergence and replica counts after each
      # NOTE: This test reveals convergence issues - failures are expected and logged for investigation
      - name: Replica validation test (stepwise consistency)
        run: |
          echo "Running replica validation with step-by-step consistency"
          echo "NOTE: This test may fail due to known convergence issues being investigated"
          cargo test -p freenet --features simulation_tests --test sim_network \
            replica_validation_and_stepwise_consistency -- \
            --ignored --test-threads=1 --nocapture || echo "Test failed - convergence issues detected (expected)"

      # Dense network replication test (higher connectivity)
      - name: Dense network replication test
        run: |
          echo "Running dense network replication test"
          cargo test -p freenet --features simulation_tests --test sim_network \
            dense_network_replication -- \
            --ignored --test-threads=1 --nocapture

      # Long-duration simulation test (1 hour virtual time)
      # Uses Turmoil deterministic scheduler for reproducible results
      # Uncovers time-dependent bugs that only manifest after extended operation
      # Wall clock time: ~3 minutes (with 19.6x time acceleration)
      - name: Long-running simulation (1 hour virtual time)
        run: |
          echo "Running 1-hour long-running deterministic simulation test"
          echo "This tests for time-dependent bugs (connection timeouts, state drift, etc.)"
          cargo test -p freenet --features "simulation_tests,testing,nightly_tests" --test simulation_integration \
            test_long_running_1h_deterministic -- \
            --test-threads=1 --nocapture

      # Large network test - requires riverctl, skipped if not available
      - name: Run large network test (50+ nodes)
        run: |
          echo "Running large network simulation with seed: $SIMULATION_SEED"
          if command -v riverctl &> /dev/null; then
            cargo test -p freenet --test large_network -- --ignored --nocapture --test-threads=1
          else
            echo "Skipping large_network test - riverctl not installed"
          fi

  # Notify Matrix channel on failure
  # Uses curl directly because the matrix-message action doesn't URL-encode room IDs
  notify-failure:
    name: Notify Matrix on Failure
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: large-scale-simulation
    if: failure()
    steps:
      - name: Send failure message to Matrix
        env:
          MATRIX_ACCESS_TOKEN: ${{ secrets.MATRIX_ACCESS_TOKEN }}
          MATRIX_ROOM_ID: ${{ secrets.MATRIX_DEV_ROOM_ID }}
        run: |
          # Room ID is stored pre-encoded in the secret (with ! as %21 and : as %3A)
          ENCODED_ROOM_ID="$MATRIX_ROOM_ID"

          # Plain text fallback
          BODY="ðŸš¨ Nightly Simulation Tests Failed - ${{ github.repository }} - Branch: ${{ github.ref_name }} - ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # HTML formatted message
          HTML="ðŸš¨ <strong>Nightly Simulation Tests Failed</strong><br><br>"
          HTML+="<strong>Repository:</strong> <a href=\"${{ github.server_url }}/${{ github.repository }}\">${{ github.repository }}</a><br>"
          HTML+="<strong>Run:</strong> <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View workflow run</a><br>"
          HTML+="<strong>Branch:</strong> <code>${{ github.ref_name }}</code><br>"
          HTML+="<strong>Commit:</strong> <code>${{ github.sha }}</code><br>"
          HTML+="<strong>Seed:</strong> <code>${{ github.event.inputs.seed || '0xDEADBEEF' }}</code><br><br>"
          HTML+="Please investigate the failure and check the logs for details."

          # Send to Matrix (show response on error for debugging)
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X PUT \
            "https://matrix.org/_matrix/client/v3/rooms/${ENCODED_ROOM_ID}/send/m.room.message/$(date +%s%N)" \
            -H "Authorization: Bearer ${MATRIX_ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg body "$BODY" --arg html "$HTML" '{msgtype: "m.text", body: $body, format: "org.matrix.custom.html", formatted_body: $html}')")

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE:")

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "Matrix API error (HTTP $HTTP_CODE): $BODY"
            exit 1
          fi
          echo "Message sent successfully"
