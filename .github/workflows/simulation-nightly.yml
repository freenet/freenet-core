name: Simulation Tests (Nightly)

# Large-scale simulation tests that are too slow for regular CI.
# Standard simulation tests (sim_network, simulation_integration, etc.)
# already run on every PR via the main CI workflow.

on:
  schedule:
    # Run at 3 AM UTC every day
    - cron: '0 3 * * *'
  workflow_dispatch:
    # Allow manual triggering from any branch
    inputs:
      ref:
        description: 'Git ref to checkout (branch, tag, or SHA). Leave empty to use the branch selected in the UI.'
        required: false
        default: ''
      seed:
        description: 'Simulation seed for reproducibility (hex, e.g., 0xDEADBEEF)'
        required: false
        default: ''

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  large-scale-simulation:
    name: Large Scale Simulation
    runs-on: self-hosted
    timeout-minutes: 60

    env:
      RUST_LOG: info
      CARGO_TARGET_DIR: ${{ github.workspace }}/target
      RUST_MIN_STACK: 16777216
      # Use mold linker to avoid rust-lld crashes
      CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER: clang
      CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: -C link-arg=-fuse-ld=mold
      # Simulation seed - use input if provided, otherwise use fixed seed for reproducibility
      SIMULATION_SEED: ${{ github.event.inputs.seed || '0xDEADBEEF' }}

    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: Show checked out ref
        run: |
          echo "Checked out ref: $(git rev-parse --abbrev-ref HEAD || git rev-parse HEAD)"
          echo "Commit: $(git rev-parse HEAD)"

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.91.0

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: simulation-large
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Clean test directories
        run: |
          rm -rf /tmp/freenet /tmp/freenet-* 2>/dev/null || true

      # Build fdev for simulation tests
      - name: Build fdev
        run: cargo build -p fdev --release

      # Medium scale test with convergence checking (20 nodes)
      # Expects 100% success rate and 100% convergence - no fault injection
      - name: Medium scale test (20 nodes, seed 0xDEADBEEF)
        run: |
          echo "Running medium scale simulation (20 nodes, 1000 events)"
          cargo run -p fdev --release -- test \
            --name "nightly-medium-20" \
            --seed 0xDEADBEEF \
            --gateways 2 \
            --nodes 18 \
            --events 1000 \
            --ring-max-htl 10 \
            --max-connections 15 \
            --min-connections 5 \
            --check-convergence 120 \
            --min-success-rate 1.0 \
            --print-summary \
            single-process

      # Medium scale with different seed (explores different code paths)
      # Expects 100% success rate and 100% convergence - no fault injection
      - name: Medium scale test (20 nodes, seed 0xCAFEBABE)
        run: |
          echo "Running medium scale simulation with alternate seed (1000 events)"
          cargo run -p fdev --release -- test \
            --name "nightly-medium-20-alt" \
            --seed 0xCAFEBABE \
            --gateways 2 \
            --nodes 18 \
            --events 1000 \
            --ring-max-htl 10 \
            --max-connections 15 \
            --min-connections 5 \
            --check-convergence 120 \
            --min-success-rate 1.0 \
            --print-summary \
            single-process

      # Fault tolerance test with message loss
      # Expects 100% success rate - eventual consistency handles retries
      - name: Fault tolerance test (5% message loss)
        run: |
          echo "Running fault tolerance simulation with 5% message loss (500 events)"
          cargo run -p fdev --release -- test \
            --name "nightly-fault-loss" \
            --seed 0xFA017001 \
            --gateways 2 \
            --nodes 12 \
            --events 500 \
            --message-loss 0.05 \
            --check-convergence 120 \
            --min-success-rate 1.0 \
            --print-summary \
            --print-network-stats \
            single-process

      # High latency test
      # Expects 100% success rate - latency shouldn't cause failures
      - name: High latency test (50-200ms latency)
        run: |
          echo "Running high latency simulation (500 events)"
          cargo run -p fdev --release -- test \
            --name "nightly-high-latency" \
            --seed 0x1A7E0C71 \
            --gateways 2 \
            --nodes 12 \
            --events 500 \
            --latency-min 50 \
            --latency-max 200 \
            --check-convergence 180 \
            --min-success-rate 1.0 \
            --print-summary \
            --print-network-stats \
            single-process

      # Larger scale test (40 nodes) - more events, longer timeout
      # Expects 100% success rate and 100% convergence - no fault injection
      - name: Large scale test (40 nodes)
        run: |
          echo "Running large scale simulation (40 nodes, 1000 events)"
          cargo run -p fdev --release -- test \
            --name "nightly-large-40" \
            --seed 0x4040BEEF \
            --gateways 3 \
            --nodes 37 \
            --events 1000 \
            --ring-max-htl 12 \
            --max-connections 20 \
            --min-connections 8 \
            --check-convergence 180 \
            --min-success-rate 1.0 \
            --print-summary \
            single-process

      # Large network test - requires riverctl, skipped if not available
      - name: Run large network test (50+ nodes)
        run: |
          echo "Running large network simulation with seed: $SIMULATION_SEED"
          if command -v riverctl &> /dev/null; then
            cargo test -p freenet --test large_network -- --ignored --nocapture --test-threads=1
          else
            echo "Skipping large_network test - riverctl not installed"
          fi
