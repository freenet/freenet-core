name: Simulation Tests (Nightly)

# Large-scale simulation tests that are too slow for regular CI.
# Standard simulation tests (sim_network, simulation_integration, etc.)
# already run on every PR via the main CI workflow.

on:
  schedule:
    # Run at 3 AM UTC every day
    - cron: '0 3 * * *'
  workflow_dispatch:
    # Allow manual triggering from any branch
    inputs:
      ref:
        description: 'Git ref to checkout (branch, tag, or SHA). Leave empty to use the branch selected in the UI.'
        required: false
        default: ''
      seed:
        description: 'Simulation seed for reproducibility (hex, e.g., 0xDEADBEEF)'
        required: false
        default: ''

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  large-scale-simulation:
    name: Large Scale Simulation
    runs-on: self-hosted
    timeout-minutes: 60

    env:
      RUST_LOG: info
      CARGO_TARGET_DIR: ${{ github.workspace }}/target
      RUST_MIN_STACK: 16777216
      # Use mold linker to avoid rust-lld crashes
      CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_LINKER: clang
      CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: -C link-arg=-fuse-ld=mold
      # Simulation seed - use input if provided, otherwise use fixed seed for reproducibility
      SIMULATION_SEED: ${{ github.event.inputs.seed || '0xDEADBEEF' }}

    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: Show checked out ref
        run: |
          echo "Checked out ref: $(git rev-parse --abbrev-ref HEAD || git rev-parse HEAD)"
          echo "Commit: $(git rev-parse HEAD)"

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.91.0

      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: simulation-large
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: Clean test directories
        run: |
          rm -rf /tmp/freenet /tmp/freenet-* 2>/dev/null || true

      # Large network test - requires riverctl, skipped if not available
      - name: Run large network test (50+ nodes)
        run: |
          echo "Running large network simulation with seed: $SIMULATION_SEED"
          if command -v riverctl &> /dev/null; then
            cargo test -p freenet --test large_network -- --ignored --nocapture --test-threads=1
          else
            echo "Skipping large_network test - riverctl not installed"
          fi

      # TODO: Add more large-scale simulation tests here
      # - 100-node network convergence
      # - Contract propagation at scale
      # - Routing algorithm stress tests
