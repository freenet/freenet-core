name: Build and Cross-Compile

on:
  workflow_dispatch:
  # Skip PRs - only build on main and releases to reduce CI costs
  push:
    branches: [main]
    tags: ['v*']

jobs:
  build-x86_64-linux:
    name: Build for x86_64-unknown-linux-musl
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-unknown-linux-musl

      - uses: Swatinem/rust-cache@v2

      - name: Install musl toolchain
        run: sudo apt-get update && sudo apt-get install -y musl-tools musl-dev

      - name: Compile for x86_64-unknown-linux-musl
        run: cargo build --release --target x86_64-unknown-linux-musl

      - name: Upload freenet binary
        uses: actions/upload-artifact@v6
        with:
          name: binaries-x86_64-linux-freenet
          path: target/x86_64-unknown-linux-musl/release/freenet

      - name: Upload fdev binary
        uses: actions/upload-artifact@v6
        with:
          name: binaries-x86_64-linux-fdev
          path: target/x86_64-unknown-linux-musl/release/fdev

  build-arm64-linux:
    name: Build for aarch64-unknown-linux-musl
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: aarch64-unknown-linux-musl

      - uses: Swatinem/rust-cache@v2

      - name: Install musl toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools musl-dev

      - name: Compile for aarch64-unknown-linux-musl
        run: cargo build --release --target aarch64-unknown-linux-musl

      - name: Upload freenet binary
        uses: actions/upload-artifact@v6
        with:
          name: binaries-arm64-linux-freenet
          path: target/aarch64-unknown-linux-musl/release/freenet

      - name: Upload fdev binary
        uses: actions/upload-artifact@v6
        with:
          name: binaries-arm64-linux-fdev
          path: target/aarch64-unknown-linux-musl/release/fdev

  build-arm64-macos:
    name: Build for aarch64-apple-darwin
    runs-on: macos-latest  # Apple Silicon runner
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - uses: Swatinem/rust-cache@v2

      - name: Compile for aarch64-apple-darwin
        run: cargo build --release

      - name: Upload freenet binary
        uses: actions/upload-artifact@v6
        with:
          name: binaries-arm64-macos-freenet
          path: target/release/freenet

      - name: Upload fdev binary
        uses: actions/upload-artifact@v6
        with:
          name: binaries-arm64-macos-fdev
          path: target/release/fdev

  build-x86_64-windows:
    name: Build for x86_64-pc-windows-msvc
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - uses: Swatinem/rust-cache@v2

      - name: Compile for x86_64-pc-windows-msvc
        run: cargo build --release

      - name: Upload freenet binary
        uses: actions/upload-artifact@v6
        with:
          name: binaries-x86_64-windows-freenet
          path: target/release/freenet.exe

      - name: Upload fdev binary
        uses: actions/upload-artifact@v6
        with:
          name: binaries-x86_64-windows-fdev
          path: target/release/fdev.exe

  attach-to-release:
    name: Attach binaries to GitHub release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build-x86_64-linux, build-arm64-linux, build-arm64-macos, build-x86_64-windows]
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      # Linux x86_64
      - name: Download x86_64 Linux freenet binary
        uses: actions/download-artifact@v7
        with:
          name: binaries-x86_64-linux-freenet
          path: artifacts/x86_64-linux-freenet

      - name: Download x86_64 Linux fdev binary
        uses: actions/download-artifact@v7
        with:
          name: binaries-x86_64-linux-fdev
          path: artifacts/x86_64-linux-fdev

      # Linux ARM64
      - name: Download ARM64 Linux freenet binary
        uses: actions/download-artifact@v7
        with:
          name: binaries-arm64-linux-freenet
          path: artifacts/arm64-linux-freenet

      - name: Download ARM64 Linux fdev binary
        uses: actions/download-artifact@v7
        with:
          name: binaries-arm64-linux-fdev
          path: artifacts/arm64-linux-fdev

      # macOS ARM64
      - name: Download ARM64 macOS freenet binary
        uses: actions/download-artifact@v7
        with:
          name: binaries-arm64-macos-freenet
          path: artifacts/arm64-macos-freenet

      - name: Download ARM64 macOS fdev binary
        uses: actions/download-artifact@v7
        with:
          name: binaries-arm64-macos-fdev
          path: artifacts/arm64-macos-fdev

      # Windows x86_64
      - name: Download x86_64 Windows freenet binary
        uses: actions/download-artifact@v7
        with:
          name: binaries-x86_64-windows-freenet
          path: artifacts/x86_64-windows-freenet

      - name: Download x86_64 Windows fdev binary
        uses: actions/download-artifact@v7
        with:
          name: binaries-x86_64-windows-fdev
          path: artifacts/x86_64-windows-fdev

      - name: Prepare release assets
        run: |
          # Create tar.gz files for each binary with binstall-compatible naming
          # Linux x86_64 (musl for maximum compatibility)
          cd artifacts/x86_64-linux-freenet && tar -czvf ../../freenet-x86_64-unknown-linux-musl.tar.gz freenet && cd ../..
          cd artifacts/x86_64-linux-fdev && tar -czvf ../../fdev-x86_64-unknown-linux-musl.tar.gz fdev && cd ../..

          # Linux ARM64 (musl for maximum compatibility)
          cd artifacts/arm64-linux-freenet && tar -czvf ../../freenet-aarch64-unknown-linux-musl.tar.gz freenet && cd ../..
          cd artifacts/arm64-linux-fdev && tar -czvf ../../fdev-aarch64-unknown-linux-musl.tar.gz fdev && cd ../..

          # macOS ARM64
          cd artifacts/arm64-macos-freenet && tar -czvf ../../freenet-aarch64-apple-darwin.tar.gz freenet && cd ../..
          cd artifacts/arm64-macos-fdev && tar -czvf ../../fdev-aarch64-apple-darwin.tar.gz fdev && cd ../..

          # Windows x86_64 (use zip for Windows)
          cd artifacts/x86_64-windows-freenet && zip ../../freenet-x86_64-pc-windows-msvc.zip freenet.exe && cd ../..
          cd artifacts/x86_64-windows-fdev && zip ../../fdev-x86_64-pc-windows-msvc.zip fdev.exe && cd ../..

          # Display the created files
          ls -lh *.tar.gz *.zip

      - name: Generate SHA256 checksums
        run: |
          # Generate checksums for all release assets
          sha256sum *.tar.gz *.zip > SHA256SUMS.txt

          # Display checksums
          echo "=== SHA256 Checksums ==="
          cat SHA256SUMS.txt

      - name: Upload binaries to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Extract the tag name (e.g., v0.1.30)
          TAG_NAME="${GITHUB_REF#refs/tags/}"

          # Upload all archives and checksums to the release
          gh release upload "$TAG_NAME" \
            freenet-x86_64-unknown-linux-musl.tar.gz \
            fdev-x86_64-unknown-linux-musl.tar.gz \
            freenet-aarch64-unknown-linux-musl.tar.gz \
            fdev-aarch64-unknown-linux-musl.tar.gz \
            freenet-aarch64-apple-darwin.tar.gz \
            fdev-aarch64-apple-darwin.tar.gz \
            freenet-x86_64-pc-windows-msvc.zip \
            fdev-x86_64-pc-windows-msvc.zip \
            SHA256SUMS.txt \
            --repo ${{ github.repository }} \
            --clobber
